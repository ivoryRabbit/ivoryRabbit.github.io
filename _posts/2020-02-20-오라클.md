---
layout: post
title: "오라클 쿼리 모음"
date: 2020-02-20 23:45:59
author: ivoryRabbit
categories: 개발
comments: true
tag: SQL
---

# 오라클(Oracle)

**HackerRank**에서 문제를 풀면서 유용하게 사용했던 쿼리들을 모아보았다.

## 소수 골라내기

1000보다 작은 소수를 조회하는 문제이다.

```sql
  WITH A as (SELECT LEVEL + 1 AS Num FROM DUAL CONNECT BY LEVEL < 1000)
     , B as (SELECT LEVEL AS Den FROM DUAL CONNECT BY LEVEL < SQRT(1000))
SELECT Num
  FROM A, B
 WHERE Num >= POWER(Den, 2)
   AND MOD(Num, Den) = 0
 GROUP BY Num
HAVING COUNT(*) = 1
 ORDER BY Num;
```

또는

```sql
  WITH A as (SELECT LEVEL + 1 AS Num FROM DUAL CONNECT BY LEVEL < 1000)
     , B as (SELECT LEVEL + 1 AS Den FROM DUAL CONNECT BY LEVEL < SQRT(1000))
SELECT Num
  FROM A
 WHERE NOT EXISTS (SELECT * FROM B WHERE Num >= POWER(Den, 2) AND MOD(Num, Den) = 0);
```

아래 쿼리와 달리 위의 쿼리에선 GROUP BY 절을 사용하기 때문에 실행계획에 정렬이 포함되고 join 횟수가 불필요하게 많아지므로 비효율적이다. 또한 이렇게 정렬된 수를 다시 보기좋게 정렬하기 위해서 ORDER BY절을 필요로하게 된다. 그러므로 숫자 $N$이 커질 경우에는 아래처럼 서브쿼리를 사용하여야 한다.

## Time interval 만들기

Project Planning 문제를 hierarchical query를 이용해 풀어보았다. 이 문제의 discussions 란을 보면, 대부분 각 project의 시작날짜와 종료날짜가 될 수 있는 후보들을 각각 뽑은 후 각 시작날짜에 대응되는 종료날짜를 짝지어주는 방법이 소개되어 있다. 예를 들면 다음과 같다.

```sql
SELECT Start_Date, MIN(End_Date)
  FROM (SELECT Start_Date FROM Projects WHERE Start_Date NOT IN (SELECT End_Date FROM Projects))
     , (SELECT End_Date FROM Projects WHERE End_Date NOT IN (SELECT Start_Date FROM Projects)) 
 WHERE Start_Date < End_Date
 GROUP BY Start_Date
 ORDER BY DATEDIFF(MIN(End_Date), Start_Date), Start_Date;
```

하지만 계층적 쿼리를 이용하면 좀 더 간단하게 작성할 수 있다.

```sql
 SELECT Start_Date
      , MAX(CONNECT_BY_ROOT End_Date)
   FROM Projects
  WHERE CONNECT_BY_ISLEAF = 1
CONNECT BY PRIOR Start_Date = End_Date
  GROUP BY Start_Date
  ORDER BY MAX(LEVEL), Start_Date;
```

이 방법은 일반적인 경우에도 tree 구조의 root와 leaf를 matching시켜 뽑아낼 수 있기 때문에 유용하다고 생각한다.

## 15 Days of Learning SQL

2016년 3월 1일부터 2016년 3월 15일까지 15일 동안 매일 문제를 푼 사람들을 조회하는 문제이다. 단, data 자료형을 사용하지 않고 날짜가 바뀌더라도 돌아가는 강건한 쿼리를 만들고자 했다. WHERE 구문에 두 서브쿼리를 비교하는 문법이 가능하다는 것을 이 문제를 풀면서 알게되었다. 또한 GROUP BY절이 사용된 쿼리에서 윈도우 함수 속에 KEEP(... ORDER BY COUNT(...))와 같이 집계함수를 넣을 수 있다는 것을 알 수 있었다.

```sql
SELECT A.submission_date
     , A.num_hackers
     , B.hacker_id
     , C.name
  FROM (
      SELECT submission_date
           , COUNT(DISTINCT hacker_id) AS num_hackers
        FROM Submissions A
       WHERE (
           SELECT COUNT(DISTINCT submission_date)
             FROM Submissions
            WHERE submission_date < A.submission_date
       ) = (
           SELECT COUNT(DISTINCT submission_date)
             FROM Submissions
            WHERE hacker_id = A.hacker_id
              AND submission_date < A.submission_date
       )
       GROUP BY submission_date
  ) A
  LEFT OUTER JOIN (
       SELECT submission_date,
              hacker_id
         FROM (
             SELECT submission_date
                  , hacker_id
                  , ROW_NUMBER() OVER(
                      PARTITION BY submission_date 
                          ORDER BY COUNT(submission_id) DESC
                                 , hacker_id
                    ) AS r
               FROM Submissions
              GROUP BY submission_date, hacker_id
         )
        WHERE r = 1
  ) B
    ON A.submission_date = B.submission_date
  JOIN Hackers C
    ON B.hacker_id = C.hacker_id;
```
