---
layout: post
title:  "상관관계와 상관계수"
date:   2020-01-27 14:36:59
author: ivoryRabbit
categories: 수학
comments: true
tag: 통계
---

# 상관계수(correlation coefficient)

두 변수(variable)가 얼마나 상관관계가 있는지 측정하는 척도이다. 상관계수가 반드시 **선형적이다**의 의미를 포함하고 있진 않지만, 대부분의 상관계수가 선형성을 측정하고 있는 피어슨 상관계수로부터 비롯되고 있다.

추천시스템(recomendation system)의 협력 필터링(collaborative filtering)에서 두 아이템 혹은 두 고객의 유사도(similarity)를 계산하거나, 추천이 얼마나 성공적인지 계산하는 평가함수(evaluation function)으로 사용된다.

## 1. 피어슨(Pearson) 상관계수

두 변수 X와 Y에 대해 각각 3개의 다음과 같은 관측치가 있다고 하자.

$$ X = (1, 2, 3)\\ Y = (4, 5, 6) $$

우리는 두 변수 $X$와 $Y$에 따라 다음을 만족하는 함수 $\rho$를 만들어 사용하고 싶다.

- $X$가 커짐에 따라 $Y$가 커지면 높은 값의 $\rho$를 가짐
- $X$와 $Y$의 상관관계가 없으면 낮은 값의 $\rho$를 가짐
- $X$가 커짐에 따라 $Y$가 작아지면 훨씬 더 낮은 값의 $\rho$를 가짐

주어진 $X$와 $Y$를 벡터(vector)라고 생각하면, 우리는 위의 세가지를 모두 충족시키는 척도를 이미 알고 있다. 바로 **내적(inner product)**이다. 실제로 내적을 계산해보면 다음을 얻게된다.

$$\langle X, Y \rangle = (1 * 4) + (2 * 5) + (3 * 6) = 32$$

32라는 값은 $X$와 $Y$의 나열 순서를 달리할 때 얻을 수 있는 가장 큰 내적 값이다. 무슨말이냐하면, $X$를 고정하고 $Y = (6, 5, 4)$로 순서를 섞으면 내적값은 32보다 작다.

$$\langle X, Y \rangle = (1 * 6) + (2 * 5) + (3 * 4) = 28 < 32$$

어떻게 순서를 나열하더라도 32라는 값을 넘기지 못하는 이러한 성질은 간단한 귀납법으로 증명할 수 있다.

---
**_proof_**

Let $X = (x_1, x_2, \ldots, x_n)$ and $Y = (y_1, y_2, \ldots, y_n)$ be given. Assume that $X$ is increasing. We will show that the inner product $\langle X, Y \rangle = \sum\limits_{i=1}^n x_i \cdot y_i$ has the maximum value when $Y$ is also increasing. In other words, $Y_0 = \underset{Y}{\arg\max} \langle X, Y \rangle$ if and only if $Y_0$ is increasing.

Suppose that $y_k = \max\limits_j y_j$. Note that $x_n = \max\limits_i x_i$. For any two indices $i\neq n$, $j\neq k$, consider two equations

$$x_n \cdot y_k + x_i \cdot y_j$$

$$x_n \cdot y_j + x_i \cdot y_k$$

By the following,

$$
\begin{aligned}
(x_n \cdot y_k + x_i \cdot y_j&) - (x_n \cdot y_j + x_i \cdot y_k) 
\\ &= x_n \cdot (y_k- y_j) - x_i \cdot (y_k - y_j)
\\ &= (x_n - x_i) \cdot (y_k - y_j) \geq 0
\end{aligned}
$$

we obatin $x_n \cdot y_n + x_i \cdot y_j \geq x_n \cdot y_j + x_i \cdot y_n$ (equality holds only when $x_n = x_i$ and $y_k = y_j$). Since $x_i$ and $y_j$ are arbitrary, $x_n$ should be multiplied with $y_k = \max\limits_j y_j$.

Hence, we may assume $n = k$ and so $\max\limits_Y \langle X, Y \rangle = x_n \cdot y_n + \max\limits_{Y'}\langle X', Y' \rangle$, where $X' = (x_1, x_2, \ldots, x_{n-1})$ and $Y' = (y_1, y_2, \ldots, y_{n-1})$. Then our claim will be done recursively.

---

하지만 단순히 내적을 취하는 방식은 $X$와 $Y$ 값이 달라질 때마다 다른 기준치를 갖게 . 예를 들어, 

$$ X = (1, 2, 3)\\ Y_1 = (4, 5, 6)\\ Y_2 = (-2, -1, 0) $$

이라고 하자. 여기서 $X = Y_2 + 3$, $Y_1 = X + 3$이라는 동일한 선형 관계를 가짐에도 불구하고 각각의 내적은 다른 값을 갖게 된다.

$$ \rho(X, Y_1) = \langle X, Y_1 \rangle = 1*4 + 2*5 + 3*6 = 32 $$

$$ \rho(X, Y_2) = \langle X, Y_2 \rangle = 1*(-2) + 2*(-1) + 3*0 = -4 $$

이러한 문제점을 해결하기 위해 각각의 변수에 대한 **평균값** 혹은 **기대값** $\mu$를 계산하여 빼주는 방법이 있다. 즉, 

$$\rho(X, Y) := \langle X - \mu(X), Y - \mu(Y) \rangle$$

으로 정의하는 것이다.

이렇게하면 $X$와 $Y$가 실제로 선형적인 관계일 때, 기존의 내적보다는 개선된 상관계수의 역할을 한다.

---
**_proof_**

Suppose $Y = aX + b$. By the linearity of expectation, $\mu(Y) = a\mu(X) + b$. Remind that $a\mu(X) = \mu(Y) - b$.

If we plug in $X-\mu(X)$ and $Y-\mu(Y)$ instead of $X$ and $Y$, we obtain

$$
\begin{aligned}
a(X - \mu(X)) + b &= (aX + b) - a\mu(X)
\\ &= Y - \mu(Y) + b
\\ &= (Y - \mu(Y)) + b
\end{aligned}
$$

Hence

$$
Y - \mu(Y) = a(X - \mu(X))
$$

Now, $b$ is not considerable anymore! 

---

위의 방법으로 평균을 뺀 변수 $X$, $Y_1$, $Y_2$ 사이의 상관계수를 구하면 다음과 같다.

$$ X = Y_1 = Y_2 = (-1, 0, 1) $$

$$ \langle X, Y_1 \rangle = \langle X, Y_2 \rangle = 2 $$

만약 두 변수가 $Y = aX + b$를 만족한다면, 각 변수의 평균을 빼줌으로써 $b = 0$이라고 가정할 수 있게 된다. 이때 우리의 상관계수는 다음과 같은데

$$ \rho(X, Y) = \langle X, Y \rangle = \langle X, aX \rangle = a\left\lVert X \right\rVert^2 $$

여전히 $\rho$는 기울기 $a$ 및 변수의 크기에 영향을 받고 있다. 예를 들어

$$ X = (-1, 0, 1)\\ Y_1 = (-2, 0, 2)\\ Y_2 = (-3, 0, 3) $$

라 하면, 평균이 모두 $0$이고 서로 양의 선형관계를 보이지만 $\rho$값이 다르다.

$$ \rho(X, Y_1) = \langle X, Y_1 \rangle = (-1)*(-2) + 1*2 = 4 $$

$$ \rho(X, Y_2) = \langle X, Y_2 \rangle = (-1)*(-3) + 1*3 = 6 $$

이 문제는 각각의 변수를 **표준편차**로 나누어줌으로써 해결할 수 있다. 즉,

$$ \rho(X, Y) := \langle \frac{X - \mu(X)}{\sigma(X)}, \frac{Y - \mu(Y)}{\sigma(Y)} \rangle $$

으로 정의하면 변수의 크기에 구애받지 않는 상관계수를 얻을 수 있다.

---
**_proof_**

Since we assume $\mu(X) = 0$, $\sigma(X) = \sqrt{\sum\limits_{i=1}^n x_i^2} = \left\lVert X \right\rVert$. Similarly $\sigma(Y) =  \left\lVert Y \right\rVert $.

Note that $Y = aX$ implies

$ \sigma(Y) = |a| \sigma(X) $ . Then,

$$
\begin{aligned}
a (\frac{X}{\sigma(X)}) &= a \frac{|a|X}{|a|\sigma(X)}
\\ &= |a| \frac{aX}{|a|\sigma(X)}
\\ &= |a| \frac{Y}{\sigma(Y)}
\end{aligned}
$$

if $a \neq 0$. Hence

$$
\frac{Y}{\sigma(Y)} = \frac{a}{|a|} \cdot \frac{X}{\sigma(X)} \Rightarrow \frac{Y}{\left\lVert Y \right\rVert} = \frac{a}{|a|} \cdot \frac{X}{\left\lVert X \right\rVert}
$$

---

여기서 우리는 다음 두 가지 중요한 점을 관찰할 수 있다.

1. 각 변수를 평균을 빼서 업데이트하면 표준편차는 변수의 크기와 같다.
2. $Y = aX+b$를 만족할 때, $\rho(X, Y) = \text{sgn}(a)$ 이다.

$X = (x_1, x_2, \ldots, x_n)$, $Y = (y_1, y_2, \ldots, y_n)$이라 하여 $\rho$를 풀어쓰면 다음과 같은 식이 나온다.

$$
\rho(X, Y) = \frac{\sum\limits_{i=1}^n (x_i - \mu(X) \cdot (y_i - \mu(Y))}{\sqrt{\sum\limits_{i=1}^n(x_i - \mu(X))^2}\cdot \sqrt{\sum\limits_{i=1}^n(y_i - \mu(Y))^2}}
$$

우리는 이러한 함수 $\rho$를 **피어슨 상관계수(Pearson Correlation Coefficient)**라고 부른다. 피어슨 상관계수는 두 unit vector가 이루는 각도의 $\cos$ 값이기 때문에 $-1$에서 $1$ 사이의 값을 가진다. (Cauchy-Schwarz 부등식으로도 증명 가능하다.)

피어슨 상관계수는 결과적으로 다음 세 조건을 만족한다.

- $X$가 커짐에 따라 $Y$가 커지면 $\rho$가 $1$에 가까워짐
- $X$와 $Y$의 상관관계가 없으면 $\rho$가 $0$에 가까워짐
- $X$가 커짐에 따라 $Y$가 작아지면 $\rho$가 $-1$에 가까워짐

위의 관점에서 피어슨 상관계수를 일반화하면 어떨까?

두 변수를 각각 평균을 덜어낸 후 vector로 생각한다. 이를 unit vector로 만들어주고 내적을 하는데, 이 때 내적은 두 unit vector가 이루는 각도 $\theta$의 $\cos$값이다.

만약 변수가 세 개라면 각 변수의 평균을 덜어내고 unit vector로 normalization을 수행한다. 그 결과 값인 세 개의 unit vector가 이루는 각도들을 이용하면 될 것이다.

## 2. 스피어만(Spearman) 상관계수

**스피어만 상관계수(Spearman Correlation coefficient)**는 위에서 다룬 피어슨 상관계수로 부터 변형되어 만들어진 함수이다. 우선 피어슨 상관계수 대신에 스피어만 상관계수를 사용하는 목적을 살펴보자.

1. 피어슨 상관계수는 변수 $X$와 $Y$가 continuous ordinal scale임을 가정한다. 스피어만 상관계수는 continuous뿐만 아니라 discrete ordinal scale에도 적용할 수 있다.

2. 스피어만 상관계수는 **선형성**에 덜 민감하다. 두 변수가 $Y = 2X+1$를 만족하든 $Y = e^X$를 만족하든, 피어슨 상관관계는 다르겠지만 스피어만 상관계수는 같다.

스피어만 상관계수의 정의는 우선 변수들의 **rank ordering**를 계산하는데서 시작한다. 예를 보면 더 쉽다.

$$ X = (5, -3, 4, 1) \Rightarrow \text{rk}(X) = (1, 4, 2, 3) $$

$X$에서 관측치 $5$가 가장 크기 때문에 $1$이라는 rank를 가진다. 그다음 $-3$은 가장 작은 수이므로 rank 값은 $4$이다. SQL에서의 RANK() 함수와 동일하다. 이제 크기가 $n$인 두 변수 $X$와 $Y$가 있을 때 스피어만 상관계수는 다음과 같이 정의된다.

$$ r_s := 1 - \frac{6 \cdot \left\lVert rk(X) - rk(Y) \right\rVert^2}{n(n^2-1)} $$

$rk(X)$와 $rk(Y)$의 $i$번째 관측치의 rank의 차이를 $d_i$라 하여 식을 표현하기도 한다.

$$ r_s := 1 - \frac{6 \cdot \sum\limits_{i=1}^n d_i^2}{n(n^2-1)} $$

스피어만 상관계수는 피어슨 상관계수와 굉장히 달라보이지만 실은 변수를 rank로 바꾼 후 피어슨 상관계수를 계산한 것과 같다.

---

**_proof_**

Note that both $X$ and $Y$ have size $n$. We may assume that both $X$ and $Y$ are already applied by the $rk()$ function. Consider

$$ \rho(X, Y) := \langle \frac{X - \mu(X)}{\sigma(X)}, \frac{Y - \mu(Y)}{\sigma(Y)} \rangle $$

Since $X$ and $Y$ are permutations of $ [n] = \{ 1, 2, \ldots, n \} $, we get 

$$ \sum_{i=1}^n x_i = \sum_{i=1}^n i = \frac{n(n+1)}{2} $$

and

$$ \sum_{i=1}^n x_i^2 = \sum_{i=1}^n i^2 = \frac{n(n+1)(2n+1)}{6} $$


---
