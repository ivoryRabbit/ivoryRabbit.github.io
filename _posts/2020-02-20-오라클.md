---
layout: post
title: "유용한 오라클 쿼리 모음"
date: 2020-02-20 23:45:59
author: ivoryRabbit
categories: 개발
comments: true
tag: SQL
---

# 오라클(Oracle)

실무에서 사용하거나 혹은 **HackerRank**에서 문제를 풀면서 유용하게 사용했던 쿼리들을 모아놓았다.

## 소수 골라내기

**HackerRank**에서 1000보다 작은 소수를 뽑는 문제가 나와서 이를 Oracle을 이용해 풀어보았다.

```sql
  WITH A as (SELECT LEVEL + 1 AS Num FROM DUAL CONNECT BY LEVEL < 1000)
     , B as (SELECT LEVEL AS Den FROM DUAL CONNECT BY LEVEL <= SQRT(1000))
SELECT Num
  FROM A, B
 WHERE Num >= POWER(Den, 2)
   AND MOD(Num, Den) = 0
 GROUP BY Num
HAVING COUNT(*) = 1
 ORDER BY Num;
```

또는

```sql
  WITH A as (SELECT LEVEL + 1 AS Num FROM DUAL CONNECT BY LEVEL < 1000)
     , B as (SELECT LEVEL + 1 AS Den FROM DUAL CONNECT BY LEVEL <= SQRT(1000))
SELECT Num
  FROM A
 WHERE NOT EXISTS (SELECT * FROM B WHERE Num >= POWER(Den, 2) AND MOD(Num, Den) = 0)
 ORDER BY Num;
```

아래 쿼리와 달리 위의 쿼리에선 group by 절을 사용하기 때문에 실행계획에 정렬이 포함되고 join 횟수가 불필요하게 많아지므로 비효율적이다. 그러므로 숫자 $N$이 커질 경우에는 아래처럼 서브쿼리를 이용하여야 한다.

## Time interval 만들기

**HackerRank**의 Project Planning 문제를 hierarchical query를 이용해 풀어보았다. 이 문제의 discussions 란을 보면, 대부분 각 project의 시작날짜와 종료날짜가 될 수 있는 후보들을 각각 뽑은 후 각 시작날짜에 대응되는 종료날짜를 짝지어주는 방법이 소개되어 있다. 예를 들면,

```sql
SELECT Start_Date, MIN(End_Date)
  FROM (SELECT Start_Date FROM Projects WHERE Start_Date NOT IN (SELECT End_Date FROM Projects))
     , (SELECT End_Date FROM Projects WHERE End_Date NOT IN (SELECT Start_Date FROM Projects)) 
 WHERE Start_Date < End_Date
 GROUP BY Start_Date
 ORDER BY DATEDIFF(MIN(End_Date), Start_Date), Start_Date;
```

하지만 계층적인 구조를 이용하면 쿼리를 간단하게 짤 수 있다.

```sql
 SELECT Start_Date
      , MAX(CONNECT_BY_ROOT End_Date)
   FROM Projects
  WHERE CONNECT_BY_ISLEAF = 1
CONNECT BY PRIOR Start_Date = End_Date
  GROUP BY Start_Date
  ORDER BY MAX(LEVEL), Start_Date;
```

이 방법은 일반적인 경우에서도, tree 구조의 root와 leaf를 matching시켜 뽑아낼 수 있기 때문에 유용하다고 생각한다.
