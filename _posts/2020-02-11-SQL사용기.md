---
layout: post
title: "SQL사용기"
date: 2020-02-11 23:15:59
author: ivoryRabbit
categories: 개발
comments: true
tag: SQL
---

# SQL

최근까지 Oracle을 이용하여 데이터를 추출하면서 많은 시련들이 있었다. 내가 업무를 하는동안 SQL을 데이터 추출하는 용도만 써왔기 때문에 SQL의 정확한 언어나 개념을 잘 알지 못하고 얘기하는 것일 수도 있다.

처음에는 정보처리기사 책으로 DBMS를 공부할까 했지만, 책의 설명이 너무 거북해서 오라클 기본 책과 튜닝 책 한권씩 읽었다. 어느정도 경험이 쌓이면서 겪었던 어려움들을 가장 괴로웠던 순서대로 나열해 보기로 했다.

1. 비등가 조인(non equi join)
  - 조인(join)의 개념이 어렵다든가 하는 문제가 아니다. 두 테이블이 PK-FK 관계를 갖지 않아 수식을 만들어서 relation을 억지로 만들어야 하는 경우가 있었다. 레이저와 센서가 한번에 많은 양의 데이터를 주고받지 못하는 기술적인 문제인지 아니면 임베디드시스템과 데이터베이스를 설계하면서 놓친 것인지 알 수 없지만, 아무튼 FK를 가져아할 테이블에 FK가 없어 join하는데 많은 고생을 했다.
  - 그래서 데이터가 전송된 시간과 거리의 차이를 계산하여, FK를 가져야할 테이블에 PK를 갖고 있는 테이블을 left join하면서 rank() 함수로 candidate들의 순위를 매겼다. 효율을 위해 거리차와 시간차를 도메인 지식을 이용해 미리 제한을 두거나, rank over partition by를 이용해 두 테이블의 순위를 계산하여 매칭시키는 방법도 이용했다. 이러한 방식에도 시간과 좌표를 전송하는 방식이 너무 상이하여 순위의 매칭 방법을 복잡하게 설계하는 경우도 있었다.

2. 로그데이터에 대한 집계
  - 한번에 핸들링할 데이터의 개수가 2억개가 넘는 상황에서 aggregation 함수를 적용하기가 쉽지않은 상황이다. 테이블을 조회하는데도 몇십분이 걸리는데 집계까지 하면 언제 끝이날지 알 수 없다.

3. 노이즈 변수
  - 데이스베이스가 오랫동안 운영돼 오면서 예전에는 사용했지만 현재는 사용하지 않는 변수가 있거나, 같은 데이터를 이름만 다른 두 변수에 나누어 담는 등의 문제가 있었다.
  - 분석 중에 문제가 있음을 파악한 후에 다시 데이터베이스로 돌아와 NVL, NVL2, DECODE, CASE WHEN END 같은 쿼리를 이용해 처리하였다.

4. 부족한 지식
  - 데이터를 뽑아내는 효율이 너무 느린것 같다. 실행계획을 보면서 쿼리를 짜는 연습을 필요로하지만, 현재 사용하고 있는 환경에서 실행계획을 볼 수가 없다. 그래서 최대한 튜닝책을 참고하고 있다.
  - 인덱스를 공부해야할 것 같다. 참고 [블로그](https://theone79.tistory.com/900){: target="_blank" }
  
5. GPS
  - 튀는 GPS 값때문에 aggregation하기가 너무 무서울 때가 있다.
